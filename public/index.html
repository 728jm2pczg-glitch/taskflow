<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TaskFlow</title>
    <style>
      body { font-family: system-ui, -apple-system, sans-serif; max-width: 720px; margin: 24px auto; padding: 0 12px; }
      form { display: flex; gap: 8px; margin: 16px 0; }
      input { flex: 1; padding: 10px; }
      button { padding: 10px 12px; }
      ul { list-style: none; padding: 0; }
      li { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #ddd; }
      .title.done { text-decoration: line-through; opacity: 0.6; }
      .spacer { flex: 1; }
      .small { font-size: 12px; opacity: 0.7; }
    </style>
  </head>
  <body>
    <h1>TaskFlow</h1>
    <div class="small" id="health"></div>

    <form id="form">
      <input id="title" placeholder="タスクを入力" />
      <button type="submit">追加</button>
    </form>

    <ul id="list"></ul>

    <script>
      const healthEl = document.getElementById("health");
      const form = document.getElementById("form");
      const titleInput = document.getElementById("title");
      const list = document.getElementById("list");

      async function api(path, options = {}) {
        const res = await fetch(path, {
          headers: { "Content-Type": "application/json" },
          ...options,
        });
        if (res.status === 204) return null;
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
        return data;
      }

      async function loadHealth() {
        const data = await api("/api/healthz");
        healthEl.textContent = `API OK / Node ${data.node}`;
      }

      function render(tasks) {
        list.innerHTML = "";
        for (const t of tasks) {
          const li = document.createElement("li");

          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.checked = t.done;
          cb.addEventListener("change", async () => {
            await api(`/api/tasks/${t.id}`, {
              method: "PATCH",
              body: JSON.stringify({ done: cb.checked }),
            });
            await refresh();
          });

          const span = document.createElement("span");
          span.className = "title" + (t.done ? " done" : "");
          span.textContent = t.title;

          const spacer = document.createElement("span");
          spacer.className = "spacer";

          const del = document.createElement("button");
          del.textContent = "削除";
          del.addEventListener("click", async () => {
            await api(`/api/tasks/${t.id}`, { method: "DELETE" });
            await refresh();
          });

          li.appendChild(cb);
          li.appendChild(span);
          li.appendChild(spacer);
          li.appendChild(del);
          list.appendChild(li);
        }
      }

      async function refresh() {
        const data = await api("/api/tasks");
        render(data.tasks);
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const title = titleInput.value.trim();
        if (!title) return;
        await api("/api/tasks", { method: "POST", body: JSON.stringify({ title }) });
        titleInput.value = "";
        await refresh();
      });

      (async () => {
        await loadHealth();
        await refresh();
      })();
    </script>
  </body>
</html>
